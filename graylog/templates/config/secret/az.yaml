{{- if eq .Values.provider "azure" }}
apiVersion: v1
kind: Secret
metadata:
  name: azure-sp-secret
  namespace: kube-system
type: Opaque
stringData:
  CLIENT_ID: "your-service-principal-client-id"
  CLIENT_SECRET: "your-service-principal-secret"
  TENANT_ID: "your-tenant-id"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: configure-vm
  namespace: kube-system
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: configurator
          image: mcr.microsoft.com/azure-cli:latest
          env:
            - name: RESOURCE_GROUP
              value: "YOUR_RESOURCE_GROUP"
            - name: CLUSTER_NAME
              value: "YOUR_CLUSTER_NAME"
          envFrom:
            - secretRef:
                name: azure-sp-secret
          command:
            - /bin/bash
            - -c
            - |
              az login --service-principal -u $CLIENT_ID -p $CLIENT_SECRET -t $TENANT_ID

              NODE_RG=$(az aks show -g $RESOURCE_GROUP -n $CLUSTER_NAME --query nodeResourceGroup -o tsv)

              for VMSS in $(az vmss list -g $NODE_RG --query "[].name" -o tsv); do
                  az vmss run-command invoke \
                    --resource-group $NODE_RG \
                    --name $VMSS \
                    --instance-id "*" \
                    --command-id RunShellScript \
                    --scripts "sysctl -w vm.max_map_count=262144"
              done
{{- end }}