{{- if .Values.graylog.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: init-script-cm
data:
  init-script.sh: |
    #!/bin/sh
    # initialize data dir
    if [ -f /mnt/data/journal/.lock ]; then
      echo "Data already initialized, skipping copy."
    else
      # copy data dir
      cp -r /usr/share/graylog/data/* /mnt/data/
    fi
    {{- if .Values.graylog.config.plugins.enabled }}
    # copy plugins
    [ -d /mnt/shared/plugins ] && find /mnt/shared/plugins/ -type f -name '*.jar' -exec cp {} /mnt/plugins/ \;

    {{- if and .Values.graylog.config.init.assetFetch.enabled .Values.graylog.config.init.assetFetch.plugins.enabled }}
    # retrieve plugins directly
    for urlchecksum in $(echo "${INIT_GRAYLOG_PLUGIN_URLS}" | tr "^" "\n"); do
      name=$(echo "$urlchecksum" | cut -d'|' -f1)
      url=$(echo "$urlchecksum" | cut -d'|' -f2)
      checksum=$(echo "$urlchecksum" | cut -d'|' -f3)
      wget -T 5 -t 3 "$url" -O "$name.jar" || { echo "Failed to fetch plugin $name.jar at $url"; continue; }
      if [ -n "$checksum" ]; then
        actual=$(sha256sum "$name.jar" | awk '{print $1}')
        if [ "$checksum" = "$actual" ]; then
          echo "Plugin checksum matches for $name.jar"
          cp "$name.jar" "/mnt/plugins/" && rm "$name.jar"
        else
          echo "Plugin checksum does NOT match for $name. Skipping plugin."
          rm "$name.jar"
        fi
      else
        echo "Warning: no checksum validation has been performed for plugin $name.jar"
        cp "$name.jar" "/mnt/plugins/" && rm "$name.jar"
      fi
    done
    {{- end }}
    {{- end }}
    {{- if and .Values.graylog.config.geolocation.enabled .Values.graylog.config.init.assetFetch.enabled .Values.graylog.config.init.assetFetch.geolocation.enabled }}
    mkdir -p /mnt/data/geolocation
    # retrieve geolocation mmdb files directly
    for urlchecksum in $(echo "${INIT_GRAYLOG_GEO_MMDB_URLS}" | tr "^" "\n"); do
      name=$(echo "$urlchecksum" | cut -d'|' -f1)
      url=$(echo "$urlchecksum" | cut -d'|' -f2)
      checksum=$(echo "$urlchecksum" | cut -d'|' -f3)
      wget -T 5 -t 3 "$url" -O "$name.mmdb" || { echo "Failed to fetch geolocation database $name.mmdb at $url"; continue; }
      if [ -n "$checksum" ]; then
        actual=$(sha256sum "$name.mmdb" | awk '{print $1}')
        if [ "$checksum" = "$actual" ]; then
          echo "Checksum matches for $name.mmdb"
          cp "$name.mmdb" "/mnt/data/geolocation/" && rm "$name.mmdb"
        else
          echo "Checksum does NOT match for $name.mmdb. Skipping database."
          rm "$name.mmdb"
        fi
      else
        echo "Warning: no checksum validation has been performed for database $name.mmdb"
        cp "$name.mmdb" "/mnt/data/geolocation/" && rm "$name.mmdb"
      fi
    done
    {{- end }}
    # check mongo credentials
    if env | grep GRAYLOG_MONGODB_URI | grep -q "@"; then
      echo "MongoDB credentials set. We're good to go!"
    else
      echo "Error: MongoDB credentials not set in MongoDB URI. Make sure secrets are up to date."
      exit 1
    fi
    {{- end }}